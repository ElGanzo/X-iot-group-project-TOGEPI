#this script generates two XIoT Scenario PSM views starting from a Feature Model PSM (with its Feature Operation Model PSM)
#"first view" is the model containing a view of the systems and devices in the Feature model.
#"second view" refers to the model containing devices with their operations/events and all their attributes

#obiettivo è creare psm della piattaforma giusta: pim viene creato solo per poter poi generare psm giusto
#TODO primo step: creare la vista (vuota) del nuovo modello: fatto
#TODO lo script carica un Feature Model System dal modello attivo e genera un X-IoT System con lo stesso nome e gli stessi attributi

GENERATE_SCENARIO

PROCEDURE global GENERATE_SCENARIO {
    CC "Modeling" GET_ACT_MODEL
    SETG a_srcmodelid:(modelid)
    SETG a_opssrcmodelid:0
    SETG a_dstmodelid:0
    SETG a_opsdstmodelid:0
    CC "AdoScript" MLISTBOX entries:"ThingsBoard;Losant;Azure"
        toksep:";"
        title:"Select platform"
        oktext:"Generate"
        boxtext:"Select your desired platform"
        #extra:{CHECKBOX "Generate something else too additionally... (can be added)"}
    IF (endbutton = "ok") {
        # CC "AdoScript" INFOBOX (selection)
        CREATE_NEW_MODEL
    } ELSIF {
        EXIT
    }

    #TODO implement: if selection is not azure, other scripts get executed instead
    # some global procedure call here

    #(todo implement)
    #set active model a_dstmodelid
    #call procedure pim to psm
}

PROCEDURE global CREATE_NEW_MODEL {
    CC "CoreUI" MODEL_SELECT_BOX without-models mgroup-sel title:"Select a target modelgroup"
    IF (endbutton != "ok") {
        SETL targetID:-1
        EXIT
    }
    CC "Core" GET_MODEL_BASENAME modelid:(modelid)
        SETL ecode:1
        WHILE (ecode != 0) {
        CC "AdoScript" EDITFIELD title:("Insert new model name..." + basename) caption:("~Modelname:")
        IF (ecode != 0) {
            SETL targetID:-1
            EXIT
        }
        CC "Core" CREATE_MODEL modeltype:("IoT Scenario") modelname:(text) version:"" mgroups:(mgroupids)
        IF (ecode = 0) {
            SET a_dstmodelid:(modelid)
        } ELSIF (ecode = 40) {
            CC "AdoScript" ERRORBOX ("A model with the same name already exists!") ok
        } ELSE {
            CC "AdoScript" ERRORBOX ("An error occured creating the new model: " + STR errtext) ok
        }
        CC "Core" CREATE_MODEL modeltype:("IoT Scenario") modelname:(text + " - operations") version:"" mgroups:(mgroupids)
        SET a_opsdstmodelid:(modelid)

        #questo script genera un PIM. poi con script già esistenti viene fatto il PSM.
        CC "Core" SET_ATTR_VAL objid:(a_dstmodelid) attrname:"Model Type" val:("PIM")

        GENERATE_ELEMENTS   #crea vista base

        GENERATE_DEVICE_SECOND_VIEW devicemap:devicemap #crea vista dettagliata dispositivi
    }

}

PROCEDURE global GENERATE_ELEMENTS {
    #copia tutti oggetti classe Feature (Feature model)
    CC "Core" GET_ALL_OBJS_OF_CLASSNAME modelid:(a_srcmodelid) classname:"Feature"
    SETL allobjs:(objids)
    LOAD_FEATURE_FEATURES featureobjs:(allobjs) featureobjsmap:objsmap
    CC "AdoScript" INFOBOX (objsmap)
    CREATE_SELECTED_OBJECTS featureobjs:(objsmap) featureobjsmap:objsmap
    CC "AdoScript" INFOBOX (objsmap)
    CREA_CONNETTORI featureobjs:(objsmap) ecode:ecode

}

PROCEDURE global LOAD_FEATURE_FEATURES featureobjs:string featureobjsmap:reference {
    SET featureobjsmap:(map())
    FOR featureid in:(featureobjs) {
        CC "Core" GET_ATTR_VAL objid:(VAL featureid) attrname:("Selection")
        IF (val = "Selected") {
            CC "Core" GET_ATTR_VAL objid:(VAL featureid) attrname:("Name")
            SETL name:(val)
            CC "Core" GET_ATTR_VAL objid:(VAL featureid) attrname:("Description")
            SETL description:(val)
            CC "Core" GET_CLASS_ID objid:(VAL featureid)
            CC "Core" GET_CLASS_NAME classid:(classid)
            SETL type:(classname)
            SETL featureobjsmap[featureid]:({
                "Name": name,
                "Description": description,
                "Class": type
            })
        }
    }
    #questa struttura poteva venire rappresentata come un LEO text.
    #immagina che featureobjsmap["Class"] sia come LEO get-keyword.
    #in pratica, questa mappa contiene oggetti di vario tipo e classe
}

PROCEDURE global CREATE_SELECTED_OBJECTS featureobjs:map featureobjsmap:reference {
    #questa funzione crea solamente gli oggetti, senza posizionarli o collegarli.

    #TODO:
    #creare interref da feature model a xiot scenario per ogni device (vedere se funziona)
    SETG x:(2cm)
    SETG y:(2cm)
    SETG xiotobjs:(map())
    CC "Modeling" OPEN modelids:(a_dstmodelid)
    SET ecode:0
    SETL currclass:"none"
    FOR featureid in:(mapKeysList(featureobjs)) sep:("~") {
        SETL featureobj:(featureobjs[featureid])
        SETL featobjid:(featureid)
        GET_CORRECT_XIOT_CLASSID featobjid:(VAL featobjid) xiotclassid:xiotclassid
        CC "Core" CREATE_OBJ modelid:(a_dstmodelid) classid:(xiotclassid)
        SETL newobjid:(objid)
        CC "Core" SET_ATTR_VAL objid:(objid) attrname:"name" val:(featureobj["Name"])
        CC "Core" SET_ATTR_VAL objid:(objid) attrname:"description" val:(featureobj["Description"])
        # SETL featureobj["NewId"]:(objid)
        SETL currclass:(featureobj["Class"])
        CC "Core" GET_CONNECTORS objid:(VAL featureid) out
        SETL subs:""
        FOR connid in:(objids) {
            CC "Core" GET_CONNECTOR_ENDPOINTS objid:(VAL connid)
            CC "Core" GET_ATTR_VAL objid:(toobjid) attrname:("Selection")
            IF (val = "Selected") {
                SET subs:(subs + STR toobjid + " ")   # elemento a cui è collegato nel livello sotto
            }
        }
        #CC "AdoScript" INFOBOX (subs)
        SETL featureobjs[featureid]:({
            "NewId": newobjid,  #VAL
            "Class": currclass,
            "Subs": subs
        })
        SETL fff:(featureid)
        SETL xiotobjs[STR newobjid]:({
            "OldId": fff,   #VAL
            "Class": currclass
        })
    }
    #mette la posizione giusta nel modello

    SET featureobjsmap:(featureobjs)    #reference
}

PROCEDURE global CREA_CONNETTORI featureobjs:map ecode:reference {
    SET ecode:0
    FOR featureid in:(mapKeysList(featureobjs)) sep:("~") {
        SETL featureobj:(featureobjs[featureid])
        IF (featureobj["Class"] = "Feature") {
            CC "Core" GET_CLASS_ID relation classname:"subsystem"
            SETL relclassid:(classid)
        } ELSIF (featureobj["Class"] = "System") {
            CC "Core" GET_CLASS_ID relation classname:"hasDevice"
            SETL relclassid:(classid)
        }
        SETL subs:(featureobj["Subs"])
        FOR sub in:(subs) {
            IF (sub != "" AND sub != " ") {
                SETL tmpobj:(featureobjs[sub])
                SETL xiotobjid:(tmpobj["NewId"])
                CC "Core" CREATE_CONNECTOR modelid:(a_dstmodelid) fromobjid:(featureobj["NewId"]) toobjid:(xiotobjid) classid:(relclassid)
            }
        }
    }
    
    POSIZIONA
}

PROCEDURE global POSIZIONA {
    SETG x:(2cm)
    SETG y:(2cm)
    CC "Core" GET_ALL_OBJS_OF_CLASSNAME modelid:(a_dstmodelid) classname:"system"
    FOR objid in:(objids) {
        CC "Modeling" SET_OBJ_POS objid:(VAL objid) x:(x) y:(y)
        NEXT_POSITION
    }
    NEW_ELEMENT_LINE
    CC "Core" GET_ALL_OBJS_OF_CLASSNAME modelid:(a_dstmodelid) classname:"device"
    FOR objid in:(objids) {
        CC "Modeling" SET_OBJ_POS objid:(VAL objid) x:(x) y:(y)
        NEXT_POSITION
    }
    #stesso per i device 
}

PROCEDURE global NEW_ELEMENT_LINE {
    SET x:2cm
    SET y:(y + 6cm)
}

PROCEDURE global GET_CORRECT_XIOT_CLASSID featobjid:integer xiotclassid:reference {
    CC "Core" GET_CLASS_ID objid:(featobjid)
    CC "Core" GET_CLASS_NAME classid:(classid)
    SETL featclassname:(classname)
    IF (featclassname = "Feature" OR featclassname = "System") {
        CC "Core" GET_CLASS_ID classname:("system")
    } ELSIF (featclassname = "Device") {
        CC "Core" GET_CLASS_ID classname:("device")
    } ELSIF (featclassname = "Operation") {
        CC "Core" GET_ATTR_VAL objid:(featobjid) attrname:("Class")
        IF (val = "Event") {
            CC "Core" GET_CLASS_ID classname:("Event")
        } ELSIF (val = "Operation") {
            CC "Core" GET_CLASS_ID classname:("Device Operation")
        }
    }
    SET xiotclassid:(classid)   #TODO aggiungere controlli per risultati inattesi
}

PROCEDURE global GENERATE_DEVICE_SECOND_VIEW devicemap:reference {
    CC "Core" GET_ALL_OBJS_OF_CLASSNAME modelid:(a_srcmodelid) classname:("Device")
    SETL devids:(objids)
    FOR devid in:(devids) {
        CC "Core" GET_INTERREF objid:(VAL devid) attrname:"Component" index:0
        SET a_opssrcmodelid:(tmodelid)
        BREAK
    }
    CC "Core" GET_ALL_OBJS_OF_CLASSNAME modelid:(a_opssrcmodelid) classname:("Device")
    SET devicemap:(map())
    FOR devid in:(objids) {
        
    }
}

PROCEDURE global GENERATE_DEVICES_OPERATIONS {

}

PROCEDURE global GENERATE_OPERATIONS {

}

PROCEDURE global GENERATE_EVENTS {

}