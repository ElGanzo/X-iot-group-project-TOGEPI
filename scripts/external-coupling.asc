#===============================================
#---- INIT GLOBAL VARS
ON_EVENT "AppInitialized"
{
EXECUTE file:("db:\\ASC_GlobalFunctions_Conversion.asc")
EXECUTE file:("db:\\ASC_GlobalFunctions_JSON.asc")
EXECUTE file:("db:\\ASC_RandomDistributions.asc")
EXECUTE file:("db:\\translator.asc")
EXECUTE file:("db:\\mapKeySetFunctions_v2.asc")
EXECUTE file:("db:\\PIM_TO_PSM.asc")
EXECUTE file:("db:\\PSM_TO_FILE.asc")
EXECUTE file:("db:\\PSM_TYPES.asc")
}

ON_EVENT "AfterEditAttributeValue" {
   # CC "AdoScript" INFOBOX "Attributo modificato"
   SETG objId:(instid)
   SETG attrId:(attrid)
   
   # CC "AdoScript" INFOBOX (attrId)   
   EXECUTE file:("db:\\editattr.asc")
 CC "Core" GET_ATTR_NAME attrid:(attrid)
     IF (attrname = "Service") {
   ADD_VALUE objID:(objId)
}
}

ON_EVENT "AfterCreateModelingNode" {
 CC "Core" GET_ATTR_VAL objid:(modelid) attrname:("Model Type")
 IF (val = "PSM") {
  CC "Core" GET_ATTR_VAL objid:(modelid) attrname:("Platform")
  ELEMENT_PSM platform:(val) objID:(objid)
 }
}

ON_EVENT "AfterCreateModelingConnector" {

 SET id_relationclassid: (classid)
 SET id_frominstanceid: (fromobjid)
 SET id_toinstanceid: (toobjid)
 SET id_model: (modelid)
 SET id_conn: (objid)

 CC "Core" GET_CLASS_NAME classid: (id_relationclassid)
 SET str_classname: (classname)

 CC "Core" GET_CONNECTORS objid:(id_toinstanceid) in
 SETL str_objids:(objids)

 # IN pratica se ho piÃ¹ di un connettore dei miei constrain tipi lo blocco

 SETL str_ool:"b"
 FOR str_objid in:(str_objids) sep:" " {
  CC "Core" GET_CLASS_ID objid:(VAL str_objid)    
  CC "Core" GET_CLASS_NAME classid:(classid)
    
  IF (classname = "Domain" OR classname = "SpecialCase" OR classname = "Mandatory" OR classname = "Optional" OR classname = "AND" OR classname = "OR" OR classname = "XSSA" OR classname = "XSA" OR classname = "OSA") {
   IF (str_ool = "b") {
    SETL str_ool:"a"
   }
   ELSE {
    # Distruggo il connettore
    CC "Core" DELETE_CONNECTOR modelid:(id_model) objid:(id_conn)
    EXIT -1
   }
  }
 }

 # Devo controllare che posso inserirlo in questo punto
 CC "Core" GET_CONNECTORS objid:(id_frominstanceid) out
 SETL str_objids:(objids)
 
 FOR str_objid in:(str_objids) sep:" " {
  CC "Core" GET_CLASS_ID objid:(VAL str_objid)    
  CC "Core" GET_CLASS_NAME classid:(classid)
     
  IF (str_classname = "AND" OR str_classname = "OR" OR str_classname = "XSSA" OR str_classname = "XSA" OR str_classname = "OSA") {
   IF (classname != str_classname) {
    IF (classname = "DOInput" OR classname = "DOOutput") {

    } ELSE {
     CC "Core" DELETE_CONNECTOR modelid:(id_model) objid:(id_conn)
     EXIT -1
    }
   }
  }

  IF (str_classname = "Mandatory" OR str_classname = "Optional" OR str_classname = "Domain" OR str_classname = "SpecialCase") {
   IF (classname = "OR" OR classname = "AND" OR classname = "XSSA" OR classname = "XSA" OR classname = "OSA") {
    CC "Core" DELETE_CONNECTOR modelid:(id_model) objid:(id_conn)
    EXIT -1
   }
  }
 }
}

#ITEM "Hello World"
#acquisition:"Extras" modeling:"Extras" analysis:"Extras"
#EXECUTE file:("C:\\Users\\arian\\Documents\\Ado modelling\\platform_asc.asc")

# Create menu items

ITEM "ThingsBoard" modeling:"Conversion"
PRESET_PSM platform:("ThingsBoard")

ITEM "Losant" modeling:"Conversion"
PRESET_PSM platform:("Losant")

ITEM "Convertion in code" modeling: "Generate the Variant"
TRANSLATE_PSM_TO_FILE

ITEM "PIM to PSM" modeling: "Generate the Variant"
TRANSLATE_PIM_TO_PSM

ITEM "Operations" modeling: "Generate devices operations"
EXECUTE file:("db:\\operation.asc")